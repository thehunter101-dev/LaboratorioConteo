{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conteo de Personas en Laboratorio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'aplicacion1/css/style.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="style.css" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/fontawesome.min.css">
</head>
<body>
    <h1 class="page-title">
        <i class="fas fa-video me-2"></i>
        Sistema de Conteo de Personas
    </h1>

    <div class="main-container">
        <div class="video-section">
            <div class="controls">
                <button id="btnIniciar" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>
                    Iniciar
                </button>
                <button id="btnDetener" class="btn btn-danger">
                    <i class="fas fa-stop me-2"></i>
                    Detener
                </button>
                <button id="btnCaptura" class="btn btn-success">
                    <i class="fas fa-camera me-2"></i>
                    Capturar
                </button>
                <button id="btnGuardarReporte" class="btn btn-warning">
                    <i class="fas fa-save me-2"></i>
                    Guardar Reporte
                </button>
            </div>

            <div class="video-container" id="container_video">
                <div class="container_black" id="container_black">
                    <i class="fa-solid fa-video-slash icon" id="icon"></i>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-card">
                <h3 class="stats-title">
                    <i class="fas fa-user-group"></i>
                    Conteo Actual
                </h3>
                <div class="counter-display" id="currentCount">
                    <span>0</span>
                    <small>personas</small>
                </div>
            </div>

            <div class="stats-card">
                <h3 class="stats-title">
                    <i class="fas fa-clock-rotate-left"></i>
                    Histórico
                </h3>
                <div id="historico" class="history-list"></div>
            </div>

            <div class="stats-card">
                <h3 class="stats-title">
                    <i class="fas fa-images"></i>
                    Capturas Recientes
                </h3>
                <div class="captures-grid" id="capturasList">
                    <!-- Las capturas se mostrarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <div id="status" class="alert" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>
        <span class="status-message"></span>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let eventSource = null;
        let previousCount = 0;

        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                element.text(current);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function mostrarMensaje(mensaje, tipo) {
            const status = $('#status');
            status.removeClass('alert-success alert-danger alert-info')
                  .addClass(`alert-${tipo}`)
                  .fadeIn(300);
            $('.status-message').text(mensaje);
            
            setTimeout(() => {
                status.fadeOut(300);
            }, 3000);
        }

        function iniciarStream() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/video_feed/');
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Actualizar video sin parpadeo
                const videoFeed = $('#videoFeed');
                videoFeed.attr('src', 'data:image/jpeg;base64,' + data.frame);

                // Animar el contador
                const currentCount = parseInt(data.count);
                if (currentCount !== previousCount) {
                    animateValue($('#currentCount span'), previousCount, currentCount, 500);
                    previousCount = currentCount;
                }

                actualizarEstadisticas();
            };
        }

        function detenerStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        function formatearFecha(fechaStr) {
            const fecha = new Date(fechaStr);
            return fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function actualizarEstadisticas() {
            $.get('/estadisticas/', function(data) {
                if (data.historico) {
                    let html = '<ul class="list-group">';
                    data.historico.slice(0, 5).reverse().forEach(function(registro) {
                        const hora = formatearFecha(registro[0]);
                        html += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-clock me-2 text-muted"></i>
                                    ${hora}
                                </span>
                                <span class="badge bg-primary rounded-pill">
                                    ${registro[1]} personas
                                </span>
                            </li>`;
                    });
                    html += '</ul>';
                    $('#historico').html(html);
                }
            });
        }

        $(document).ready(function() {
            $('#btnIniciar').click(function() {
                const btn = $(this);
                let container_black = document.getElementById('container_black');
                if (container_black == null){
                    container_black = document.createElement('div');
                    container_black.id = 'container_black';
                    container_black.id = "container_black";
                }
                const container_video = document.getElementById('container_video');
                const video_enable = document.createElement('img');
                const load_icon = document.createElement('i');
                const icon = document.getElementById('icon');
                load_icon.className = "fa-solid fa-spinner loader"
                video_enable.id = 'videoFeed';
                video_enable.className = 'video-feed';
                video_enable.alt = 'Video en vivo';
                icon.remove();
                load_icon.id = 'load_icon';
                container_black.appendChild(load_icon);
                setTimeout(()=>{
                    container_black.remove();
                    container_video.appendChild(video_enable);
                },5500)
                btn.prop('disabled', true);
                
                $.get('/iniciar/', function(data) {
                    mostrarMensaje(data.status, 'success');
                    iniciarStream();
                    $('#btnDetener').prop('disabled', false);
                }).fail(function() {
                    mostrarMensaje('Error al iniciar el conteo', 'danger');
                }).always(function() {
                    btn.prop('disabled', false);
                });
            });

            $('#btnDetener').click(function() {
                const btn = $(this);
                const container_black = document.createElement('div');
                const icon = document.createElement('i');
                container_black.className = "container_black";
                container_black.id = "container_black";
                icon.className = "fa-solid fa-video-slash icon"
                icon.id = "icon";
                container_black.appendChild(icon);
                 const videoFeed = document.getElementById('videoFeed');
                 if (videoFeed) {
                     videoFeed.remove();
                 }
                 container_video.appendChild(container_black);
                btn.prop('disabled', true);
                
                $.get('/detener/', function(data) {
                    mostrarMensaje(data.status, 'info');
                    detenerStream();
                    $('#btnIniciar').prop('disabled', false);
                }).fail(function() {
                    mostrarMensaje('Error al detener el conteo', 'danger');
                }).always(function() {
                    btn.prop('disabled', false);
                });
            });

            // Deshabilitar botón de detener al inicio
            $('#btnDetener').prop('disabled', true);

            // Manejar el botón de captura
            $('#btnCaptura').click(function() {
                const videoFrame = $('#videoFeed').attr('src');
                if (videoFrame) {
                    const timestamp = new Date().toLocaleString('es-ES');
                    const captureCount = $('#currentCount span').text();
                    
                    // Crear una nueva tarjeta de captura
                    const captureCard = `
                        <div class="col-12 col-md-6 col-lg-4 capture-item">
                            <div class="capture-card" data-imagen="${videoFrame}" data-personas="${captureCount}">
                                <img src="${videoFrame}" alt="Captura ${timestamp}">
                                <div class="capture-info">
                                    <small>${timestamp}</small>
                                    <div><strong>${captureCount}</strong> personas detectadas</div>
                                </div>
                                <div class="capture-actions">
                                    <button onclick="descargarCaptura(this)" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button onclick="eliminarCaptura(this)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#capturasList').prepend(captureCard);
                    mostrarMensaje('Captura guardada correctamente', 'success');
                }
            });

            // Manejar el botón de guardar reporte
            $('#btnGuardarReporte').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);
                
                // Recopilar todas las capturas
                const capturas = [];
                $('.capture-card').each(function() {
                    const $card = $(this);
                    const imagen = $card.attr('data-imagen');
                    const personas = parseInt($card.attr('data-personas')) || 0;
                    
                    console.log('Procesando captura:', {imagen: imagen ? 'presente' : 'ausente', personas: personas});
                    
                    if (imagen) {
                        capturas.push({
                            imagen: imagen,
                            personas: personas
                        });
                    }
                });
                
                console.log(`Total de capturas recopiladas: ${capturas.length}`);
                
                // Verificar si hay capturas
                if (capturas.length === 0) {
                    mostrarMensaje('No hay capturas para guardar. Capture algunas imágenes primero.', 'info');
                    btn.prop('disabled', false);
                    return;
                }
                
                // Obtener contador actual
                const numeroPersonas = parseInt($('#currentCount span').text()) || 0;
                
                // Preparar datos del reporte
                const reporteData = {
                    laboratorio: 'Laboratorio Principal',
                    numero_personas: numeroPersonas,
                    observaciones: `Reporte generado con ${capturas.length} capturas`,
                    capturas: capturas
                };
                
                console.log('Datos a enviar:', reporteData);
                
                // Enviar al servidor
                $.ajax({
                    url: '/reporte/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reporteData),
                    success: function(response) {
                        if (response.status === 'success') {
                            mostrarMensaje(
                                `Reporte guardado: ${response.capturas_guardadas} capturas almacenadas`,
                                'success'
                            );
                            
                            // Limpiar capturas después de guardar
                            setTimeout(() => {
                                if (confirm('¿Desea limpiar las capturas guardadas?')) {
                                    $('#capturasList').empty();
                                }
                            }, 1000);
                        } else {
                            mostrarMensaje('Error al guardar: ' + response.mensaje, 'danger');
                        }
                    },
                    error: function(xhr) {
                        let mensaje = 'Error al guardar el reporte';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            mensaje = response.mensaje || mensaje;
                        } catch(e) {}
                        mostrarMensaje(mensaje, 'danger');
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                    }
                });
            });
        });

        // Función para descargar la captura
        function descargarCaptura(button) {
            const card = $(button).closest('.capture-card');
            const img = card.find('img').attr('src');
            const timestamp = card.find('.capture-info small').text();
            
            const link = document.createElement('a');
            link.href = img;
            link.download = `captura_${timestamp.replace(/[/: ]/g, '-')}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Función para eliminar la captura
        function eliminarCaptura(button) {
            $(button).closest('.col-12').fadeOut(300, function() {
                $(this).remove();
            });
            mostrarMensaje('Captura eliminada', 'info');
        }
    </script>
</body>
</html>